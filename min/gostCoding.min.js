/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(A,t){"function"===typeof define&&define.amd?define(["gostCrypto"],t):"object"===typeof exports?module.exports=t(require("gostCrypto")):A.GostCoding=t(A.gostCrypto)})(this,function(A){function t(e){if(e instanceof y)return e;if(e&&e.buffer&&e.buffer instanceof y)return 0===e.byteOffset&&e.byteLength===e.buffer.byteLength?e.buffer:(new Uint8Array(new Uint8Array(e,e.byteOffset,e.byteLength))).buffer;throw new u("CryptoOperationData required");}function s(){}var u=this.DataError||this.Error,
y=this.ArrayBuffer,B=this.Date,C={decode:function(e){e=e.replace(/[^A-Za-z0-9\+\/]/g,"");for(var l=e.length,c=3*l+1>>2,p=new Uint8Array(c),d,a=0,r=0,g=0;g<l;g++){d=g&3;var h=e.charCodeAt(g),h=64<h&&91>h?h-65:96<h&&123>h?h-71:47<h&&58>h?h+4:43===h?62:47===h?63:0,a=a|h<<18-6*d;if(3===d||1===l-g){for(d=0;3>d&&r<c;d++,r++)p[r]=a>>>(16>>>d&24)&255;a=0}}return p.buffer},encode:function(e){e=new Uint8Array(t(e));for(var l=2,c="",p=e.length,d=0,a=0;a<p;a++)if(l=a%3,0<a&&0===4*a/3%96&&(c+="\r\n"),d|=e[a]<<
(16>>>l&24),2===l||1===p-a){for(var r=18;0<=r;r-=6)var g=d>>>r&63,g=26>g?g+65:52>g?g+71:62>g?g-4:62===g?43:63===g?47:65,c=c+String.fromCharCode(g);d=0}return c.substr(0,c.length-2+l)+(2===l?"":1===l?"=":"==")}};s.prototype.Base64=C;var w=function(){var e={1026:128,1027:129,8218:130,1107:131,8222:132,8230:133,8224:134,8225:135,8364:136,8240:137,1033:138,8249:139,1034:140,1036:141,1035:142,1039:143,1106:144,8216:145,8217:146,8220:147,8221:148,8226:149,8211:150,8212:151,8482:153,1113:154,8250:155,1114:156,
1116:157,1115:158,1119:159,160:160,1038:161,1118:162,1032:163,164:164,1168:165,166:166,167:167,1025:168,169:169,1028:170,171:171,172:172,173:173,174:174,1031:175,176:176,177:177,1030:178,1110:179,1169:180,181:181,182:182,183:183,1105:184,8470:185,1108:186,187:187,1112:188,1029:189,1109:190,1111:191},l={},c;for(c in e)l[e[c]]=c;return{decode:function(c,d){d=(d||"win1251").toLowerCase().replace("-","");for(var a=[],r=0,g=c.length;r<g;r++){var h=c.charCodeAt(r);if("utf8"===d)128>h?a.push(h):(2048>h?
a.push(192+(h>>>6)):(65536>h?a.push(224+(h>>>12)):(2097152>h?a.push(240+(h>>>18)):(67108864>h?a.push(248+(h>>>24)):(a.push(252+(h>>>30)),a.push(128+(h>>>24&63))),a.push(128+(h>>>18&63))),a.push(128+(h>>>12&63))),a.push(128+(h>>>6&63))),a.push(128+(h&63)));else if("unicode"===d||"ucs2"===d||"utf16"===d)if(55296>h||57344<=h&&65536>=h)a.push(h>>>8),a.push(h&255);else{if(65536<=h&&1114112>h){var h=h-65536,b=((1047552&h)>>10)+55296,h=(1023&h)+56320;a.push(b>>>8);a.push(b&255);a.push(h>>>8);a.push(h&255)}}else"utf32"===
d||"ucs4"===d?(a.push(h>>>24&255),a.push(h>>>16&255),a.push(h>>>8&255),a.push(h&255)):"win1251"===d?(128<=h&&(h=1040<=h&&1104>h?h-848:e[h]||0),a.push(h)):a.push(h&255)}return(new Uint8Array(a)).buffer},encode:function(e,d){d=(d||"win1251").toLowerCase().replace("-","");for(var a=[],c=new Uint8Array(t(e)),g=0,h=c.length;g<h;g++){var b=c[g];if("utf8"===d)b=252<=b&&254>b&&g+5<h?1073741824*(b-252)+(c[++g]-128<<24)+(c[++g]-128<<18)+(c[++g]-128<<12)+(c[++g]-128<<6)+c[++g]-128:b>>248&&252>b&&g+4<h?(b-248<<
24)+(c[++g]-128<<18)+(c[++g]-128<<12)+(c[++g]-128<<6)+c[++g]-128:b>>240&&248>b&&g+3<h?(b-240<<18)+(c[++g]-128<<12)+(c[++g]-128<<6)+c[++g]-128:224<=b&&240>b&&g+2<h?(b-224<<12)+(c[++g]-128<<6)+c[++g]-128:192<=b&&224>b&&g+1<h?(b-192<<6)+c[++g]-128:b;else if("unicode"===d||"ucs2"===d||"utf16"===d){if(b=(b<<8)+c[++g],55296<=b&&57344>b)var n=b-55296<<10,b=c[++g],b=(b<<8)+c[++g],b=n+(b-56320)+65536}else"utf32"===d||"ucs4"===d?(b=(b<<8)+c[++g],b=(b<<8)+c[++g],b=(b<<8)+c[++g]):"win1251"===d&&128<=b&&(b=192<=
b&&256>b?b+848:l[b]||0);a.push(String.fromCharCode(b))}return a.join("")}}}();s.prototype.Chars=w;var F={decode:function(e,l){e=e.replace(/[^A-fa-f0-9]/g,"");var c=Math.ceil(e.length/2),p=new Uint8Array(c);e=(0<e.length%2?"0":"")+e;if(l&&("string"!==typeof l||0>l.toLowerCase().indexOf("little")))for(var d=0;d<c;d++)p[d]=parseInt(e.substr(2*(c-d-1),2),16);else for(d=0;d<c;d++)p[d]=parseInt(e.substr(2*d,2),16);return p.buffer},encode:function(e,l){var c=[],p=new Uint8Array(t(e)),d=p.length;if(l&&("string"!==
typeof l||0>l.toLowerCase().indexOf("little")))for(var a=0;a<d;a++){var r=d-a-1;c[r]=(0<r&&0===r%32?"\r\n":"")+("00"+p[a].toString(16)).slice(-2)}else for(a=0;a<d;a++)c[a]=(0<a&&0===a%32?"\r\n":"")+("00"+p[a].toString(16)).slice(-2);return c.join("")}};s.prototype.Hex=F;var D={decode:function(e){e=(e||"").replace(/[^\-A-fa-f0-9]/g,"");0===e.length&&(e="0");var l=!1;"-"===e.charAt(0)&&(l=!0,e=e.substring(1));for(;"0"===e.charAt(0)&&1<e.length;)e=e.substring(1);e=(0<e.length%2?"0":"")+e;if(!l&&!/^[0-7]/.test(e)||
l&&!/^[0-7]|8[0]+$/.test(e))e="00"+e;for(var c=e.length/2,p=new Uint8Array(c),d=0,c=c-1;0<=c;--c){var a=parseInt(e.substr(2*c,2),16);l&&0<a+d&&(a=256-a-d,d=1);p[c]=a}return p.buffer},encode:function(e){e=new Uint8Array(t(e));if(0===e.length)return"0x00";for(var l=[],c=127<e[0],p=0,d=e.length-1;0<=d;--d){var a=e[d];c&&0<a+p&&(a=256-a-p,p=1);l[d]=("00"+a.toString(16)).slice(-2)}for(l=l.join("");"0"===l.charAt(0);)l=l.substring(1);return(c?"-":"")+"0x"+l}};s.prototype.Int16=D;var E=function(){function e(c,
p,d){var a=c.object;void 0===a&&(a=c);var l=c.tagClass=c.tagClass||0;if(0===l){var g=c.tagNumber;if("undefined"===typeof g)if("string"===typeof a)g=""===a?5:/^\-?0x[0-9a-fA-F]+$/.test(a)?2:/^(\d+\.)+\d+$/.test(a)?6:/^[01]+$/.test(a)?3:/^(true|false)$/.test(a)?1:/^[0-9a-fA-F]+$/.test(a)?4:19;else if("number"===typeof a)g=2;else if("boolean"===typeof a)g=1;else if(a instanceof Array)g=16;else if(a instanceof B)g=24;else if(a instanceof y||a&&a.buffer instanceof y)g=4;else throw new u("Unrecognized type for "+
a);}var h=c.tagConstructed;"undefined"===typeof h&&(h=c.tagConstructed=a instanceof Array);var b;if(a instanceof y||a&&a.buffer instanceof y)b=new Uint8Array(t(a)),3===g&&(a=new Uint8Array(t(b)),b=new Uint8Array(a.length+1),b[0]=0,b.set(a,1));else if(h)if(a instanceof Array){for(var n=0,k=[],q=0,m=0,f=a.length;m<f;m++)k[m]=e(a[m],p),n+=k[m].length;17===g&&k.sort(function(a,b){for(var c=0,d=Math.min(a.length,b.length);c<d;c++){var e=a[c]-b[c];if(0!==e)return e}return a.length-b.length});"CER"===p&&
(k[f]=new Uint8Array(2),n+=2);b=new Uint8Array(n);m=0;for(f=k.length;m<f;m++)b.set(k[m],q),q+=k[m].length}else throw new u("Constracted block can't be primitive");else switch(g){case 1:b=new Uint8Array(1);b[0]=a?255:0;break;case 2:case 10:b=D.decode("number"===typeof a?a.toString(16):a);break;case 3:if("string"===typeof a)for(m=7-(a.length+7)%8,f=Math.ceil(a.length/8),b=new Uint8Array(f+1),b[0]=m,m=0;m<f;m++){for(n=k=0;8>n;n++)var z=8*m+n,k=(k<<1)+(z<a.length?"1"===a.charAt(z)?1:0:0);b[m+1]=k}break;
case 4:b=F.decode("number"===typeof a?a.toString(16):a);break;case 6:a=a.match(/\d+/g);b=[];for(m=1;m<a.length;m++){f=+a[m];k=[];1===m&&(f+=40*a[0]);do k.push(f&127),f>>>=7;while(f);for(n=k.length-1;0<=n;--n)b.push(k[n]+(0===n?0:128))}b=new Uint8Array(b);break;case 12:b=w.decode(a,"utf8");break;case 18:case 22:case 19:case 20:case 21:case 25:case 26:case 27:m=0;for(f=a.length;m<f;m++)255<a.charCodeAt(m)&&(g=12);b=12===g?w.decode(a,"utf8"):w.decode(a,"ascii");break;case 23:case 24:b=a.original;if(!b){b=
new B(a);b.setMinutes(b.getMinutes()+b.getTimezoneOffset());for(f=24===g?b.getMilliseconds().toString():"";0<f.length&&"0"===f.charAt(f.length-1);)f=f.substring(0,f.length-1);0<f.length&&(f="."+f);b=(23===g?b.getYear().toString().slice(-2):b.getFullYear().toString())+("00"+(b.getMonth()+1)).slice(-2)+("00"+b.getDate()).slice(-2)+("00"+b.getHours()).slice(-2)+("00"+b.getMinutes()).slice(-2)+("00"+b.getSeconds()).slice(-2)+f+"Z"}b=w.decode(b,"ascii");break;case 28:b=w.decode(a,"utf32");break;case 30:b=
w.decode(a,"utf16")}b||(b=new Uint8Array(0));b instanceof y&&(b=new Uint8Array(b));if(!h&&"CER"===p)switch(g){case 3:z=1;case 4:case 12:case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:case 28:case 30:z=z||0;n=0;k=[];q=0;m=z;for(f=b.length;m<f;m+=1E3-z)k[m]=e({object:new Unit8Array(b.buffer,m,Math.min(1E3-z,f-m)),tagNumber:g,tagClass:0,tagConstructed:!1},p),n+=k[m].length;k[f]=new Uint8Array(2);b=new Uint8Array(n+2);m=0;for(f=k.length;m<f;m++)b.set(k[m],q),q+=k[m].length}c.tagNumber=
0===l?g:g=c.tagNumber||0;c.content=b;if(d)return b;d=[];l=3===l?192:2===l?128:1===l?64:0;h&&(l|=32);if(31>g)d.push(l|g&31);else{l|=31;d.push(l);f=g;g=[];do g.push(f&127),f>>>=7;while(f);for(n=g.length-1;0<=n;--n)d.push(g[n]+(0===n?0:128))}if(h&&"CER"===p)d.push(128);else if(p=b.length,127<p){h=p;p=[];do p.push(h&255),h>>>=8;while(h);d.push(p.length+128);for(n=p.length-1;0<=n;--n)d.push(p[n])}else d.push(p);c=c.header=new Uint8Array(d);p=new Uint8Array(c.length+b.length);p.set(c,0);p.set(b,c.length);
return p}function l(c,e){var d=e||0,a=d,r,g,h,b,n,k,q;if(c.object)r=c.tagNumber,g=c.tagClass,h=c.tagConstructed,d=c.content,b=c.header,n=c.object instanceof y?new Uint8Array(c.object):null,k=c.object instanceof Array?c.object:null,q=n&&n.length||null;else{b=c[d++];r=b&31;g=b>>6;h=0!==(b&32);if(31===r){r=0;do{if(9007199254740864<r)throw new u("Convertor not supported tag number more then (2^53 - 1) at position "+e);b=c[d++];r=(r<<7)+(b&127)}while(b&128)}b=c[d++];q=b&127;if(q!==b){if(6<q)throw new u("Length over 48 bits not supported at position "+
e);if(0===q)q=null;else{for(var m=b=0;m<q;++m)b=(b<<8)+c[d++];q=b}}a=d;k=null;if(h)if(k=[],null!==q){for(b=a+q;d<b;){var f=l(c,d);k.push(f);d+=f.header.length+f.content.length}if(d!==b)throw new u("Content size is not correct for container starting at offset "+a);}else try{for(;;){f=l(c,d);d+=f.header.length+f.content.length;if(0===f.tagClass&&0===f.tagNumber)break;k.push(f)}q=d-a}catch(t){throw new u("Exception "+t+" while decoding undefined length content at offset "+a);}b=new Uint8Array(c.buffer,
e,a-e);n=d=new Uint8Array(c.buffer,a,q)}if(null!==k&&0===g){var v;switch(r){case 3:v=1;case 4:case 12:case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:case 28:case 30:v=v||0;if(0===k.length)throw new u("No constructed encoding content of string type at offset "+a);q=v;for(var m=0,x=k.length;m<x;m++){f=k[m];if(f.tagClass!==g||f.tagNumber!==r||f.tagConstructed)throw new u("Invalid constructed encoding of string type at offset "+a);q+=f.content.length-v}n=new Uint8Array(q);for(var m=0,
x=k.length,s=v;m<x;m++)f=k[m],0<v?n.set(f.content.subarray(1),s):n.set(f.content,s),s+=f.content.length-v;h=!1;k=null}}f="";if(null===k){if(null===q)throw new u("Invalid tag with undefined length at offset "+a);if(0===g)switch(r){case 1:f=0!==n[0];break;case 2:case 10:if(6<q)f=D.encode(n);else{k=n[0];127<n[0]&&(k-=256);for(m=1;m<q;m++)k=256*k+n[m];f=k}break;case 3:if(5<q)f=(new Uint8Array(n.subarray(1))).buffer;else{a=n[0];f=[];for(m=q-1;1<=m;--m){q=n[m];for(s=a;8>s;++s)f.push(q>>s&1?"1":"0");a=0}f=
f.reverse().join("")}break;case 4:f=(new Uint8Array(n)).buffer;break;case 6:f="";for(m=v=x=0;m<q;++m)k=n[m],x=(x<<7)+(k&127),v+=7,k&128||(""===f?(k=80>x?40>x?0:1:2,f=k+"."+(x-40*k)):f+="."+x.toString(),v=x=0);if(0<v)throw new u("Incompleted OID at offset "+a);break;case 16:case 17:f=[];break;case 12:f=w.encode(n,"utf8");break;case 18:case 19:case 20:case 21:case 22:case 25:case 26:case 27:f=w.encode(n,"ascii");break;case 28:f=w.encode(n,"utf32");break;case 30:f=w.encode(n,"utf16");break;case 23:case 24:q=
23===r;f=w.encode(n,"ascii");k=(q?/^(\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/:/^(\d\d\d\d)(0[1-9]|1[0-2])(0[1-9]|[12]\d|3[01])([01]\d|2[0-3])(?:([0-5]\d)(?:([0-5]\d)(?:[.,](\d{1,3}))?)?)?(Z|[-+](?:[0]\d|1[0-2])([0-5]\d)?)?$/).exec(f);if(!k)throw new u('Unrecognized time format "'+f+'" at offset '+a);q&&(k[1]=+k[1],k[1]+=50>k[1]?2E3:1900);q=new B(k[1],+k[2]-1,+k[3],+(k[4]||0),+(k[5]||0),+(k[6]||0),+(k[7]||
0));a=q.getTimezoneOffset();if(k[8]||23===r)"Z"!==k[8].toUpperCase()&&k[9]&&(a+=parseInt(k[9])),q.setMinutes(q.getMinutes()-a);q.original=f;f=q}else f=(new Uint8Array(n)).buffer}else f=k;return{tagConstructed:h,tagClass:g,tagNumber:r,header:b,content:d,object:f}}return{encode:function(c,l,d){return e(c,l,d).buffer},decode:function(c){return l(c.object?c:new Uint8Array(t(c)),0)}}}();s.prototype.BER=E;s.prototype.PEM={encode:function(e,l){return(l?"-----BEGIN "+l.toUpperCase()+"-----\r\n":"")+C.encode(e instanceof
y?e:E.encode(e))+(l?"\r\n-----END "+l.toUpperCase()+"-----":"")},decode:function(e,l,c,p){var d=/([A-Za-z0-9\+\/\s\=]+)/g.exec(e);d[1].length!==e.length&&(d=!1);!d&&l&&(d=(new RegExp("-----\\s?BEGIN "+l.toUpperCase()+"-----([A-Za-z0-9\\+\\/\\s\\=]+)-----\\s?END "+l.toUpperCase()+"-----","g")).exec(e));d||(d=/-----\s?BEGIN [A-Z0-9\s]+-----([A-Za-z0-9\+\/\s\=]+)-----\s?END [A-Z0-9\s]+-----/g.exec(e));e=d&&d[1+(p||0)];if(!e)throw new u("Not valid PEM format");e=C.decode(e);c&&(e=E.decode(e));return e}};
A&&(A.coding=new s);return s});
