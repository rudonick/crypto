/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(u,r){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1","gostCert","gostCMS"],r):"object"===typeof exports?module.exports=r(require("gostCrypto"),require("gostASN1"),require("gostCert"),require("gostCMS")):u.GostKeys=r(u.gostCrypto,u.GostASN1,u.GostCert,u.GostCMS)})(this,function(u){function r(){for(var a={},b=0,c=arguments.length;b<c;b++){var d=arguments[b];if("object"===typeof d)for(var e in d)d.hasOwnProperty(e)&&(a[e]=d[e])}return a}function L(a,b,c){for(var d in b){var e=
a,h=d,f=b[d];"object"!==typeof f&&(f={value:f});void 0!==c&&(f.enumerable=c);D.defineProperty(e,h,f)}}function A(a,b,c,d){"function"!==typeof b&&(d=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=D.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&L(b.prototype,c,!0);if(a!==D)for(var e in a)b[e]=a[e];b.super=a;d&&L(b,d,!0);return b}function B(a){a=new Uint8Array(a);u.getRandomValues(a);return a.buffer}function p(a){try{a()}catch(b){}}function M(a){if(a instanceof
E)return a;if(a&&a.buffer&&a.buffer instanceof E)return 0===a.byteOffset&&a.byteLength===a.buffer.byteLength?a.buffer:(new Uint8Array(new Uint8Array(a,a.byteOffset,a.byteLength))).buffer;throw new DataError("CryptoOperationData required");}function N(a){var b=new U;a&&b.setDate(b.getDate()+a);return b}function Q(a){a=N(a);a.setHours(0,0,0,0);return a}function y(a,b){var c=new Uint8Array(a),d=new Uint8Array(b);if(c.length!==d.length)return!1;for(var e=0,h=c.length;e<h;e++)if(c[e]!==d[e])return!1;return!0}
function G(a,b){var c=new Uint8Array(a,b,4);return c[3]<<24|c[2]<<16|c[1]<<8|c[0]}function I(a,b,c){a=new Uint8Array(a,b,4);a[3]=c>>>24;a[2]=c>>>16&255;a[1]=c>>>8&255;a[0]=c&255;return a}function V(a){switch(a.id){case "pbeWithSHAAnd40BitRC2-CBC":case "pbeWithSHAAnd128BitRC2-CBC":return 8;case "pbeUnknownGost":return 16;case "sha1":return 20;default:return 32}}function R(a,b){if(!b)return new E(0);if(0<=a.name.indexOf("CPKDF")){for(var c=[],d=0;d<b.length;d++){var e=b.charCodeAt(d);c.push(e&255);
c.push(e>>>8&255);c.push(0);c.push(0)}return(new Uint8Array(c)).buffer}return 0<=a.name.indexOf("PFXKDF")?w.Chars.decode(b+"\x00","unicode"):w.Chars.decode(b,"utf8")}function x(){}function v(a){m.PrivateKeyInfo.call(this,a)}function F(a){m.EncryptedPrivateKeyInfo.call(this,a)}function J(a){if(a){var b=this;["mk.db3","masks.db3","kek.opq","rand.opq"].forEach(function(c){b[c]=a[c]})}}function O(a,b){m.GostWrappedPrivateKey.call(this,a);J.call(this,b)}function S(a){a&&(this.header=m.GostKeyContainer.decode(a.header),
this.name=m.GostKeyContainerName.decode(a.name),this.primary=m.GostPrivateKeys.decode(a.primary),this.masks=m.GostPrivateMasks.decode(a.masks),a.primary2&&a.masks2&&(this.primary2=m.GostPrivateKeys.decode(a.primary2),this.masks2=m.GostPrivateMasks.decode(a.masks2)))}function H(a){m.ViPNetInfo.call(this,a||{version:3,keyInfo:{keyClass:1,keyType:43556,flags:1},defenceKeyInfo:{keyClass:1024,keyType:24622,keyUID:B(32),flags:-2147483648}})}function P(a){a&&(a instanceof E||a.buffer instanceof E||"string"===
typeof a)?this.decode(a):(a=a||{},this.fileType=a.fileType||"ITCS",this.fileVersion=a.fileVersion||16,a.applicationHeader&&(this.applicationHeader=a.applicationHeader),this.entries=a.entries||[])}function K(a){m.PFX.call(this,a||{version:3,authSafe:{contentType:"data"}})}function T(a){this.entries={};if(a)for(var b in a)this.setEntry(b,a[b])}var k=this.Promise,D=this.Object,E=this.ArrayBuffer,U=this.Date,g=u.subtle,m=u.asn1,w=u.coding,s=u.security.providers,q=u.cert,z=u.cms,C={providerName:"CP-01",
days:7305};x.prototype.options=C;A(m.PrivateKeyInfo,v,{getPrivateKey:function(){var a="rsaEncryption"===this.privateKeyAlgorithm.id?["sign"]:["sign","deriveKey","deriveBits"];return g.importKey("pkcs8",this.encode(),this.privateKeyAlgorithm,"true",a)},setPrivateKey:function(a){var b=this;return g.exportKey("pkcs8",a).then(function(a){m.PrivateKeyInfo.call(b,a);return b})},generate:function(a,b){var c=this;return(new k(p)).then(function(){a instanceof q.Request||(a=new q.Request(a));return a.generate(b)}).then(function(b){m.PrivateKeyInfo.call(c,
b);return a})}});x.prototype.PKCS8=v;A(m.EncryptedPrivateKeyInfo,F,{getKey:function(a){var b=this,c;return(new k(p)).then(function(){c=new z.EncryptedDataContentInfo({contentType:"encryptedData",version:0,encryptedContentInfo:{contentType:"data",contentEncryptionAlgorithm:b.encryptionAlgorithm,encryptedContent:b.encryptedData}});return c.getEnclosed(a)}).then(function(a){return v.decode(a.content)})},getPrivateKey:function(a){return this.getKey(a).then(function(a){return a.getPrivateKey()})},setKey:function(a,
b,c){var d=this,e;return(new k(p)).then(function(){a=new v(a);e=new z.EncryptedDataContentInfo;return e.encloseContent(a.encode(),b,c||C.providerName)}).then(function(){d.encryptionAlgorithm=e.encryptedContentInfo.contentEncryptionAlgorithm;d.encryptedData=e.encryptedContentInfo.encryptedContent;return d})},setPrivateKey:function(a,b,c){var d=this;return(new v).setPrivateKey(a).then(function(a){return d.setKey(a,b,c)})},generate:function(a,b,c,d){var e=this;return(new k(p)).then(function(){a instanceof
q.Request||(a=new q.Request(a));return a.generate(c)}).then(function(a){return e.setKey(a,b,d)}).then(function(){return a})}});x.prototype.PKCS8Encrypted=F;A(D,J,{getEncryptionKey:function(a){var b=s["SC-01"].wrapping,c=s["SC-01"].encryption,d=s["SC-01"].derivation,e=this["masks.db3"],h=this["mk.db3"],f=this["kek.opq"];return(new k(p)).then(function(){if(!e||!h||!f)throw Error("Not enougth key container files");if(32<e.byteLength){if(a)return g.importKey("raw",w.Chars.decode(a,"utf8"),d,!1,["deriveKey",
"deriveBits"]).then(function(a){return g.deriveKey(r(d,{salt:new Uint8Array([0,0,0,0,0,0,0,0])}),a,c,!1,["decrypt"])}).then(function(a){return(new z.EncryptedDataContentInfo(e)).getEnclosed(a)}).then(function(a){return a.verify()}).then(function(a){return a.content});throw Error("Key password is required");}if(a)throw Error("Key password is not required");return e}).then(function(a){e=a;a=new Uint8Array(h.byteLength+e.byteLength);a.set(new Uint8Array(h),0);a.set(new Uint8Array(e),h.byteLength);return g.importKey("raw",
a.buffer,b,!1,["unwrapKey"])}).then(function(a){return g.unwrapKey("raw",f,a,b,c,!1,["wrapKey","unwrapKey"])})},generateContainer:function(a){var b=this,c=s["SC-01"].wrapping,d=s["SC-01"].encryption,e=s["SC-01"].derivation,h=s["SC-01"].digest,f,l;return(new k(p)).then(function(){return g.generateKey(c,!0,["wrapKey"])}).then(function(c){l=c;c=l.buffer.byteLength;b["mk.db3"]=(new Uint8Array(new Uint8Array(l.buffer,0,c-32))).buffer;c=(new Uint8Array(new Uint8Array(l.buffer,c-32,32))).buffer;if(a){var f=
new z.EncryptedDataContentInfo,k=new z.DigestedDataContentInfo;return k.encloseContent(c,h).then(function(){k={contentType:"digestedData",content:k.encode()};return g.importKey("raw",w.Chars.decode(a,"utf8"),e,!1,["deriveKey","deriveBits"])}).then(function(a){return g.deriveKey(r(e,{salt:new Uint8Array([0,0,0,0,0,0,0,0])}),a,d,!1,["encrypt"])}).then(function(a){return f.encloseContent(k,a,d)}).then(function(){return f.encode()})}return c}).then(function(a){b["masks.db3"]=a;return g.generateKey(d,
!1,["wrapKey","unwrapKey"])}).then(function(a){f=a;return g.wrapKey("raw",a,l,c)}).then(function(a){b["kek.opq"]=a;return g.generateKey(d,!1,["wrapKey","unwrapKey"])}).then(function(a){return g.wrapKey("raw",a,l,c)}).then(function(a){b["rand.opq"]=a;return f})}});x.prototype.SignalComKeyContainer=J;A(m.GostWrappedPrivateKey,O,{getKey:function(a){return this.getPrivateKey(a).then(function(a){return(new v).setPrivateKey(a)})},getPrivateKey:function(a){var b=this,c=s["SC-01"].wrapping,d;return(new k(p)).then(function(){return b.getEncryptionKey(a,
!0)}).then(function(a){return g.unwrapKey("raw",b.privateKeyWrapped,a,c,b.privateKeyAlgorithm,!0,["sign","deriveKey","deriveBits"])}).then(function(a){return(d=b.attributes&&b.attributes["id-sc-gostR3410-2001-publicKey"])?g.generateKey(r(a.algorithm,{ukm:a.buffer}),a.extractable,a.usages):{privateKey:a}}).then(function(a){if(d&&!y(a.publicKey.buffer,d))throw Error("Check public key failed");return a.privateKey})},setKey:function(a,b){var c=this;return(new v(a)).getPrivateKey().then(function(a){return c.setPrivateKey(a,
b)})},setPrivateKey:function(a,b){var c=this,d=s["SC-01"].wrapping,e;return(new k(p)).then(function(){return c.getEncryptionKey(b)["catch"](function(){return c.generateContainer(b)})}).then(function(c){return g.wrapKey("raw",a,c,d)}).then(function(c){e=c;return g.generateKey(r(a.algorithm,{ukm:a.buffer}),!0,["sign","verify"])}).then(function(b){c.object={version:0,privateKeyAlgorithm:a.algorithm,privateKeyWrapped:e,attributes:{"id-sc-gostR3410-2001-publicKey":b.publicKey.buffer}};return c})},changePassword:function(a,
b){var c=this;return c.getPrivateKey(a).then(function(a){return c.setPrivateKey(a,b)})},generate:function(a,b,c){var d=this,e;return(new k(p)).then(function(){a instanceof q.Request||(a=new q.Request(a));return a.generate(c)}).then(function(a){e=a;return d.setKey(e,b)}).then(function(){return a})}});L(O.prototype,J.prototype);x.prototype.SignalComPrivateKeyInfo=O;A(D,S,function(){function a(a){return!(0<=a.name.indexOf("-94")||0<=a.name.indexOf("-2001")||1994===a.version||2001===a.version)}function b(c,
b,d){var e={name:"CPKDF",hash:a(c)?"GOST R 34.11-256":"GOST R 34.11-94/"+(c.sBox||"D-A"),salt:d,iterations:b?2E3:2};return g.importKey("raw",R(e,b),e,!1,["deriveKey","deriveBits"]).then(function(a){return g.deriveKey(e,a,"GOST 28147",!1,["sign","verify","encrypt","decrypt"])})}function c(a,c,d){var e=r({name:"GOST 28147-MAC"},a.encParams);return b(a,c,d).then(function(a){return g.sign(e,a,new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]))})}function d(a,c){var b=r({name:"GOST 28147-MAC"},a.encParams),
d=new Uint8Array([0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0]);return g.importKey("raw",d,b,!1,["sign"]).then(function(a){return g.sign(b,a,c.encode())})}function e(a,c,b){var d=r({name:"GOST 28147-MAC"},a.encParams);a=64===c.byteLength?(new Uint8Array(new Uint8Array(c,32,32))).buffer:c;return g.importKey("raw",a,d,!1,["sign"]).then(function(a){return g.sign(d,a,b)})}function h(a){var c=r(a,{mode:"MASK"}),b,d=B(12);c.name=c.name.replace("-DH","");return g.generateKey(c,!0,["wrapKey",
"unwrapKey"]).then(function(a){return g.exportKey("raw",a)}).then(function(c){b=c;return e(a,b,d)}).then(function(a){return new m.GostPrivateMasks({mask:b,randomStatus:d,hmacRandom:a})})}function f(a){return g.generateKey(r(a.algorithm,{ukm:a.buffer}),!0,["sign","verify"]).then(function(a){return(new Uint8Array(new Uint8Array(a.publicKey.buffer,0,8))).buffer})}function l(a,c,b,d,e){var h={name:"GOST 28147-ECB",sBox:a.encParams&&a.encParams.sBox},l=r(a,{mode:"MASK"}),n;l.name=l.name.replace("-DH",
"");var k;return g.decrypt(h,c,b).then(function(a){k=a;return g.importKey("raw",d,l,"false",["sign","unwrapKey"])}).then(function(c){return g.unwrapKey("raw",k,c,l,a,"true",["sign"])}).then(function(a){n=a;return f(n)}).then(function(a){if(!y(a,e))throw Error("Incorrect fp");return n})}function t(a,c,b,d){var e={name:"GOST 28147-ECB",sBox:a.encParams&&a.encParams.sBox},f=r(a,{mode:"MASK"});f.name=f.name.replace("-DH","");return g.importKey("raw",d,f,!1,["sign","wrapKey"]).then(function(a){return g.wrapKey("raw",
b,a,f)}).then(function(a){return g.encrypt(e,c,a)})}function n(a,c,d,f,h){var g=a.primaryPrivateKeyParameters.privateKeyAlgorithm;return(new k(p)).then(function(){if(c.hmacKey)throw Error("Old key format");if(12>d.randomStatus.byteLength)throw Error("Invalid random status length");return e(g,d.mask,d.randomStatus)}).then(function(a){if(!y(a,d.hmacRandom))throw Error("Imita for mask is invalid");return b(g,f,new Uint8Array(d.randomStatus,0,12))}).then(function(b){return h&&c.secondaryKey?l(a.secondaryPrivateKeyParameters.privateKeyAlgorithm,
b,c.secondaryKey,d.mask,a.secondaryFP):l(g,b,c.primaryKey,d.mask,a.primaryFP)})}function W(a,c,d,e,f,h){return b(a,e,new Uint8Array(d.randomStatus,0,12)).then(function(c){return t(a,c,h,d.mask)}).then(function(a){c||(c=new m.GostPrivateKeys);f?c.secondaryKey=a:c.primaryKey=a;return c})}return{getKey:function(a,c){return this.getPrivateKey(a,c).then(function(a){return(new v).setPrivateKey(a)})},getPrivateKey:function(a,c){var b=this,d=b.header.keyContainerContent;return n(d,b.primary,b.masks,a,c)["catch"](function(e){if(b.primary2&&
b.masks2)return n(d,b.primary2,b.masks2,a,c);throw e;})},getCertificate:function(a){var c=this.header.keyContainerContent;return(new k(p)).then(function(){return a?new q.X509(c.secondaryCertificate):new q.X509(c.primaryCertificate)})},getContainerName:function(){return this.name.containerName},setKey:function(a,c,b,d){var e=this;return(new v(a)).getPrivateKey().then(function(a){return e.setPrivateKey(a,c,b,d)})},setPrivateKey:function(a,b,e,l){var g=this,n,t;return(new k(p)).then(function(){g.header=
g.header||new m.GostKeyContainer({keyContainerContent:{containerAlgoritmIdentifier:{algorithm:"id-CryptoPro-GostPrivateKeys-V2-Full"},attributes:["kccaReservePrimary","kccaPrimaryKeyAbsent"],extensions:{keyValidity:{notAfter:N(l||C.days)}}}});n=g.header.keyContainerContent;var c=e?n.secondaryPrivateKeyParameters:n.primaryPrivateKeyParameters;if(c)t=c.privateKeyAlgorithm;else if(t=r(a.algorithm,{sBox:"D-A",encParams:{block:"CFB",sBox:"E-A",keyMeshing:"CP"}}),c={attributes:["pkaExportable","pkaExchange",
"pkaDhAllowed"],privateKeyAlgorithm:t},e){if(!n.primaryPrivateKeyParameters)throw Error("Primary key must be defined first");n.secondaryPrivateKeyParameters=c}else n.primaryPrivateKeyParameters=c,c=n.attributes.indexOf("kccaPrimaryKeyAbsent"),0<=c&&n.attributes.splice(c,1);var b=[];[0,1].forEach(function(a){var c="masks"+(0<a?"2":"");g[c]||b.push(h(t).then(function(a){g[c]=a}))});return k.all(b)}).then(function(){var c=[];[0,1].forEach(function(d){var f="primary"+(0<d?"2":"");c.push(W(t,g[f],g["masks"+
(0<d?"2":"")],b,e,a).then(function(a){g[f]=a}))});return k.all(c)}).then(function(){return f(a).then(function(a){e?n.secondaryFP=a:n.primaryFP=a})}).then(function(){var a=n.attributes.indexOf("kccaSoftPassword");if(b)return 0>a&&n.attributes.push("kccaSoftPassword"),c(t,b,n.primaryFP);0<=a&&n.attributes.splice(a,1)}).then(function(a){a&&(n.hmacPassword=a);return d(t,n)}).then(function(a){g.header.hmacKeyContainerContent=a;return g})},setCertificate:function(a,c,b){var e=this,f,h;return(new k(p)).then(function(){e.header=
e.header||new m.GostKeyContainer({keyContainerContent:{containerAlgoritmIdentifier:{algorithm:"id-CryptoPro-GostPrivateKeys-V2-Full"},attributes:["kccaReservePrimary","kccaPrimaryKeyAbsent"],extensions:{keyValidity:{notAfter:N(b||C.days)}}}});f=e.header.keyContainerContent;a=new q.X509(a);h=f.primaryPrivateKeyParameters&&f.primaryPrivateKeyParameters.privateKeyAlgorithm||r(a.subjectPublicKeyInfo.algorithm,{sBox:"D-A",encParams:{block:"CFB",sBox:"E-A",keyMeshing:"CP"}});return a.getPublicKey()}).then(function(b){if(c){if(f.secondaryFP&&
!y(f.secondaryFP,new Uint8Array(b.buffer,0,f.secondaryFP.byteLength)))throw Error("The public key of the certificate does not match the private key");f.secondaryCertificate=a}else{if(f.primaryFP&&!y(f.primaryFP,new Uint8Array(b.buffer,0,f.primaryFP.byteLength)))throw Error("The public key of the certificate does not match the private key");f.primaryCertificate=a}return d(h,f)}).then(function(a){e.header.hmacKeyContainerContent=a;return e})},setContainerName:function(a){this.name=new m.GostKeyContainerName({containerName:a})},
verify:function(a){var b=this,e,f;return(new k(p)).then(function(){e=b.header.keyContainerContent;f=e.primaryPrivateKeyParameters.privateKeyAlgorithm;return d(f,e)}).then(function(d){if(!y(d,b.header.hmacKeyContainerContent))throw Error("Container is not valid.");d=0<=e.attributes.indexOf("kccaSoftPassword");if(!a&&d)throw Error("Password is required");if(a&&!d)throw Error("Password is not reqiured.");return a?c(f,a,e.primaryFP).then(function(a){if(!y(a,e.hmacPassword))throw Error("Password is not valid.");
return b}):b})},changePassword:function(a,c){var b=this,d;return(new k(p)).then(function(){d=b.header.keyContainerContent;if(!d.primaryPrivateKeyParameters)throw Error("Private key not yet defined");return b.getPrivateKey(a).then(function(a){return b.setPrivateKey(a,c)})}).then(function(){return d.secondaryPrivateKeyParameters?b.getPrivateKey(a,!0).then(function(a){return b.setPrivateKey(a,c,!0)}):b})},generate:function(a,c,b){var d=this,e,f;return(new k(p)).then(function(){a instanceof q.Request||
(a=new q.Request(a));return a.generate(b)}).then(function(a){f=a;return d.setKey(f,c)}).then(function(){e=new q.X509(a);return e.sign(f)}).then(function(){return d.setCertificate(e)}).then(function(){return a})},encode:function(a){return{header:this.header.encode(a),name:this.name.encode(a),masks:this.masks.encode(a),primary:this.primary.encode(a),masks2:this.masks2.encode(a),primary2:this.primary2.encode(a)}}}}());x.prototype.CryptoProKeyContainer=S;A(m.ViPNetInfo,H,function(){function a(a){void 0===
a&&(a="");var c=w.Chars.decode(a,"win1251"),d;return g.digest("GOST R 34.11-94",c).then(function(a){d=a;a=new Uint8Array(c.byteLength+d.byteLength);a.set(new Uint8Array(c),0);a.set(new Uint8Array(d),c.byteLength);return g.digest("GOST R 34.11-94",a)}).then(function(a){return g.importKey("raw",a,"GOST 28147",!1,["unwrapKey"])}).then(function(a){return g.unwrapKey("raw",d,a,"GOST 28147-MASK/VN","GOST 28147-89","false",["encrypt","decrypt","sign","verify"])})}return{getPrivateKey:function(b){var c=this,
d,e;return(new k(p)).then(function(){return b&&"string"!==typeof b?b:a(b)}).then(function(a){b=a;d=c.keyPart;e=new Uint8Array(d,0,d.byteLength-4-8);a=new Uint8Array(d,e.byteLength,4);var f=c.keyInfo.encode(),l=new Uint8Array(e.byteLength+f.byteLength);l.set(new Uint8Array(e),0);l.set(new Uint8Array(f),e.byteLength);return g.verify({name:"GOST 28147-89-MAC"},b,a,l)}).then(function(a){if(!a)throw Error("Invalid key password");a=new Uint8Array(d,d.byteLength-8,8);return g.decrypt({name:"GOST 28147-89-CFB",
iv:a},b,e)}).then(function(a){var b=a.byteLength/2;if(c.keyInfo.keyClass&0)return g.importKey("raw",new Int32Array(a,b,b),"GOST 28147",!1,["unwrapKey"]).then(function(c){return g.unwrapKey("raw",new Int32Array(a,0,b),c,"GOST 28147-MASK/VN","GOST 28147-89","false",["encrypt","decrypt","sign","verify"])});var d=c.keyInfo.algorithm||c.certificate&&c.certificate.subjectPublicKeyInfo.algorithm;if(!d)throw Error("Algorithm is not specified");var e=r(d,{mode:"MASK",procreator:"VN"});e.name=e.name.replace("-DH",
"");var n=new Uint8Array(a,0,b),k=new Uint8Array(a,b,b);return g.importKey("raw",k,e,"false",["sign","unwrapKey"]).then(function(a){return g.unwrapKey("raw",n,a,e,d,"true",["sign","deriveBits","deriveKey"])}).then(function(a){return c.publicKey?g.generateKey(r(a.algorithm,{ukm:a.buffer}),a.extractable,a.usages):{privateKey:a}}).then(function(a){if(c.publicKey&&!y(a.publicKey.buffer,c.publicKey))throw Error("Check public key failed");return a.privateKey})})},setPrivateKey:function(b,c,d){var e=this,
h,f,l,t;return(new k(p)).then(function(){return c&&"string"!==typeof c?c:a(c)}).then(function(a){c=a;a=b.algorithm;e.keyInfo.algorithm=a;e.keyInfo.serialNumber=B(16);e.keyInfo.keyUID=B(8);e.keyInfo.validity={notBefore:Q(),notAfter:Q(d||C.days)};if("private"===b.type)return h=r(a,{mode:"MASK",procreator:"VN"}),h.name=h.name.replace("-DH",""),e.keyInfo.keyClass=1,e.keyInfo.keyType=43556,g.generateKey(r(a,{ukm:b.buffer}),!0,["sign","verify"]).then(function(a){e.publicKey=a.publicKey.buffer;if(e.certificate)return a=
e.certificate.subjectPublicKeyInfo,g.importKey("spki",a.encode(),a.algorithm,!0,["verify"])}).then(function(a){a&&!y(a.buffer,e.publicKey)&&delete e.certificate});if("secret"===b.type)h="GOST 28147/MASK/VN",delete e.certificate,delete e.publicKey,e.keyInfo.keyClass=64,e.keyInfo.keyType=24622;else throw Error("Invalid key type");}).then(function(){return g.generateKey(h,!0,["wrapKey","unwrapKey"])}).then(function(a){f=a;return g.wrapKey("raw",b,f,h)}).then(function(a){l=new Uint8Array(2*a.byteLength);
l.set(new Uint8Array(a));return g.exportKey("raw",f)}).then(function(a){l.set(new Uint8Array(a),a.byteLength);t=new Uint8Array(l.byteLength+12);a={name:"GOST 28147-CFB",iv:B(8)};t.set(new Uint8Array(a.iv),t.byteLength-8);return g.encrypt(a,c,l)}).then(function(a){t.set(new Uint8Array(a));var b=e.keyInfo.encode(),d=new Uint8Array(a.byteLength+b.byteLength);d.set(new Uint8Array(a),0);d.set(new Uint8Array(b),a.byteLength);return g.sign({name:"GOST 28147-89-MAC"},c,d)}).then(function(a){t.set(new Uint8Array(a),
t.byteLength-12);e.keyPart=t.buffer;return e})},encode:function(a){var c=m.ViPNetInfo.method("encode").call(this),d=new Uint8Array(8+c.byteLength+this.keyPart.byteLength);I(d.buffer,0,4+c.byteLength+this.keyPart.byteLength);d.set(new Uint8Array(c),4);I(d.buffer,4+c.byteLength,this.keyPart.byteLength);d.set(new Uint8Array(this.keyPart),8+c.byteLength);return"PEM"===a?w.Base64.encode(d.buffer):d.buffer}}}(),{decode:function(a){"string"===typeof a&&(a=w.Base64.decode(a));a=M(a);var b=G(a,0);if(a.byteLength!==
b+4)throw Error("Invalid container entry size");var c=w.BER.decode(new Uint8Array(a,4,b)),b=m.ViPNetInfo.decode.call(this,c),c=c.header.byteLength+c.content.byteLength,d=G(a,4+c);if(a.byteLength!==c+d+8)throw Error("Invalid container key part size");b.keyPart=(new Uint8Array(new Uint8Array(a,c+8,d))).buffer;return b}});x.prototype.ViPNetContainerEntry=H;A(D,P,{getCertificate:function(a){var b=this;return(new k(p)).then(function(){var c=b.entries[a||0];if(!c)throw Error("Entry not defined");if(c.certificate)return new q.X509(c.certificate)})},
getKey:function(a,b){return this.getPrivateKey(a,b).then(function(a){return(new v).setPrivateKey(a)})},getPrivateKey:function(a,b){var c=this;return(new k(p)).then(function(){var d=c.entries[b||0];if(!d)throw Error("Entry not defined");return d.getPrivateKey(a)})},setCertificate:function(a,b){var c=this,d;return(new k(p)).then(function(){d=c.entries[b||0]||(c.entries[b||0]=new H);a=new q.X509(a);if(d.publicKey)return a.getPublicKey()}).then(function(b){if(b&&!y(d.publicKey,b.buffer))throw Error("Invalid certificate for private key");
d.certificate=a;return c})},setKey:function(a,b,c,d){var e=this;return(new v(a)).getPrivateKey().then(function(a){return e.setPrivateKey(a,b,c,d)})},setPrivateKey:function(a,b,c,d){var e=this;return(new k(p)).then(function(){return(e.entries[c||0]||(e.entries[c||0]=new H)).setPrivateKey(a,b,d)}).then(function(){return e})},changePassword:function(a,b){var c=this;return(new k(p)).then(function(){return c.getPrivateKey(a).then(function(a){return c.setPrivateKey(a,b)})})},generate:function(a,b,c){var d=
this,e,h;return(new k(p)).then(function(){a instanceof q.Request||(a=new q.Request(a));return a.generate(c)}).then(function(a){h=a;return d.setKey(h,b)}).then(function(){e=new q.X509(a);return e.sign(h)}).then(function(){return d.setCertificate(e)}).then(function(){return a})},encode:function(a){var b=[],c=0;this.entries.forEach(function(a){a=a.encode();c+=a.byteLength;b.push(a)});var d=this.applicationHeader?this.applicationHeader.byteLength:0,e=new Uint8Array(12+d+c);e.set(new Uint8Array(w.Chars.decode(this.fileType,
"ascii")));I(e.buffer,4,this.fileVersion);I(e.buffer,8,d);0<d&&e.set(new Uint8Array(this.applicationHeader),12);var h=12+d;b.forEach(function(a){e.set(new Uint8Array(a),h);h+=a.byteLength});return"PEM"===a?w.Base64.encode(e.buffer):e.buffer},decode:function(a){a=this.constructor.decode(a);this.fileType=a.fileType;this.fileVersion=a.fileVersion;a.applicationHeader&&(this.applicationHeader=a.applicationHeader);this.entries=a.entries}},{encode:function(a,b){return(new this(a)).encode(b)},decode:function(a){"string"===
typeof a&&(a=w.Base64.decode(a));a=M(a);var b=w.Chars.encode(new Uint8Array(a,0,4),"ascii");if("ITCS"!==b&&"PKEY"!==b&&"_CCK"!==b&&"_LCK"!==b)throw Error("Unsupported ViPNet container type");var c=G(a,4),d=c>>>16;if(0!==d&&1!==d||255<(c&65535))throw Error("Unsupported ViPNet container version");var d=G(a,8),e;0<d&&(e=M(new Uint8Array(a,12,d)));for(var d=12+d,h=[];d<a.byteLength;){var f=G(a,d);h.push(H.decode(new Uint8Array(a,d,f+4)));d=d+f+4}return new P({fileType:b,fileVersion:c,applicationHeader:e,
entries:h})}});x.prototype.ViPNetContainer=P;A(m.PFX,K,function(){function a(a,b,e){var h={name:"HMAC",hash:a.hash};return g.importKey("raw",R(a,b),a,!1,["deriveKey"]).then(function(b){return g.deriveKey(a,b,h,!1,["sign"])}).then(function(a){return g.sign(h,a,e)})}function b(c,b,e,h){return a(c,b,h).then(function(a){if(!y(e,a))throw Error("Invalid password, MAC is not verified");})}return{sign:function(c,b){var e=this;return(new k(p)).then(function(){if(c){var h,f,l;b?l=s[b]:b=s[C.providerName].digest;
l?(h=l.digest,f=l.derivation):(h=b,f={name:"PFXKDF",hash:h,iterations:2E3});f=r(f,{salt:B(V(h)),diversifier:3});return a(f,c,e.authSafe.content).then(function(a){e.macData={mac:{digestAlgorithm:h,digest:a},macSalt:f.salt,iterations:f.iterations};return e})}return e})},verify:function(a){var d=this,e=d.authSafe,h;return(new k(p)).then(function(){if("data"===e.contentType){if(d.macData){if(!a)throw Error("Password must be defined for the MAC verification");h={name:"PFXKDF",hash:d.macData.mac.digestAlgorithm,
salt:d.macData.macSalt,iterations:d.macData.iterations,diversifier:3};var f=d.authSafe.content,l=d.macData.mac.digest;return b(h,a,l,f)["catch"](function(){h.name="PBKDF2";return b(h,a,l,f)})}}else throw Error("Unsupported format");}).then(function(){return d})}}}());x.prototype.PKCS12=K;A(D,T,{aliases:function(){var a=[],b;for(b in this.entries)a.push(b);return a},containsAlias:function(a){return!!this.entries[a]},deleteEntry:function(a){delete this.entries[a]},setEntry:function(a,b){var c={};if(b.key)try{c.key=
new v(b.key,!0)}catch(d){try{c.key=new F(b.key,!0)}catch(e){if(b.key instanceof E)c.key=b.key;else throw Error("Unknown Key format");}}if(b.certs){for(var h=b.certs instanceof Array?b.certs:[b.certs],f=0;f<h.length;f++)try{h[f]=new q.X509(h[f])}catch(l){}c.certs=h}if(b.crls){h=b.crls instanceof Array?b.crls:[b.crls];for(f=0;f<h.length;f++)try{h[f]=new q.CRL(h[f])}catch(g){}c.crls=h}this.entries[a]=c},getEntry:function(a){return this.entries[a]},load:function(a,b){var c=this;return(new k(p)).then(function(){a=
new K(a);return a.verify(b)}).then(function(){if("data"!==a.authSafe.contentType)throw Error("Unsupported PFX format");var c=[];m.AuthenticatedSafe.decode(a.authSafe.content).object.forEach(function(a){if("data"===a.contentType)c.push(new z.DataContentInfo(a));else if("encryptedData"===a.contentType)c.push((new z.EncryptedDataContentInfo(a)).getEnclosed(b));else throw Error("Unsupported PFX format");});return k.all(c)}).then(function(a){var c={};a.forEach(function(a){m.SafeContents.decode(a.content).object.forEach(function(a){var b=
w.Hex.encode(a.bagAttributes&&a.bagAttributes.localKeyId||B(4),!0),b=c[b]||(c[b]={});switch(a.bagId){case "keyBag":b.key=new v(a.bagValue);break;case "pkcs8ShroudedKeyBag":b.key=new F(a.bagValue);break;case "secretBag":"secret"===a.bagValue.secretTypeId&&(b.key=a.bagValue.secretValue);break;case "certBag":var d=b.certs||(b.certs=[]);"x509Certificate"===a.bagValue.certId&&d.push(new q.X509(a.bagValue.certValue));break;case "crlBag":d=b.crls||(b.crls=[]),"x509CRL"===a.bagValue.crlId&&d.push(new q.CRL(a.bagValue.crlValue))}a.bagAttributes&&
a.bagAttributes.friendlyName&&(b.friendlyName=a.bagAttributes.friendlyName)})});a=[];for(var h in c)a.push(function(a){return a.key instanceof F?a.key.getKey(b).then(function(b){a.key=b;return a})["catch"](function(){return a}):a}(c[h]));return k.all(a)}).then(function(a){a.forEach(function(a){var b=a.friendlyName;if(b)delete a.friendlyName,c.entries[b]=a;else{var b=c.entries,d;d=new Uint8Array(B(16));for(var g="",k=0;16>k;k++)g+=("00"+d[k].toString(16)).slice(-2);d=g.substr(0,8)+"-"+g.substr(8,4)+
"-4"+g.substr(13,3)+"-9"+g.substr(17,3)+"-"+g.substr(20,12);b[d]=a}});return c})},store:function(a,b,c){var d=this,e=[],g=[],f=[];return(new k(p)).then(function(){c=c?s[c]?s[c].pbes:c:b?s[b]?s[b].pbes:s[C.providerName].pbes:s[C.providerName].pbes;for(var f in d.entries){var m=new Uint32Array([1]),n=d.entries[f];n.key&&function(b,d){b instanceof E?g.push({bagId:"secretBag",bagValue:{secretTypeId:"secret",secretValue:b,bagAttributes:d}}):b instanceof v?c&&a?e.push((new F).setKey(b,a,c).then(function(a){return{bagId:"pkcs8ShroudedKeyBag",
bagValue:a,bagAttributes:d}})):e.push({bagId:"keyBag",bagValue:b,bagAttributes:d}):b instanceof F&&e.push({bagId:"pkcs8ShroudedKeyBag",bagValue:b,bagAttributes:d})}(n.key,{localKeyId:m,friendlyName:f});n.certs&&n.certs.forEach(function(a){var b={localKeyId:m};a instanceof q.X509&&g.push({bagId:"certBag",bagValue:{certId:"x509Certificate",certValue:a},bagAttributes:b})});n.crls&&n.crls.forEach(function(a){var b={localKeyId:m};a instanceof q.CRL&&g.push({bagId:"crlBag",bagValue:{crlId:"x509CRL",crlValue:a},
bagAttributes:b})})}if(0<e.length)return k.all(e)}).then(function(b){b&&(b=m.SafeContents.encode(b),f.push(new z.DataContentInfo({contentType:"data",content:b})));if(0<g.length)return g=m.SafeContents.encode(g),c&&a?(new z.EncryptedDataContentInfo).encloseContent(g,a,c):(new z.DataContentInfo).encloseContent(g)}).then(function(c){f.push(c);f=new m.AuthenticatedSafe(f);c=new K;c.authSafe={contentType:"data",content:f.encode()};return c.sign(a,b)})}});x.prototype.KeyStore=T;u.keys=new x;return x});
