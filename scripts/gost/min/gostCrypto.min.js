/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(y,g){"function"===typeof define&&define.amd?define(["gostRandom"],g):"object"===typeof exports?module.exports=g(require("gostRandom")):y.gostCrypto=g(y.GostRandom)})(this,function(y){function g(a,c){if("string"===typeof a||a instanceof String)a={name:a};var d=a.name;if(!d)throw new v("Algorithm name not defined");var e=d.split("/"),e=e[0].split("-").concat(e.slice(1)),b={},d=e[0].replace(/[\.\s]/g,""),e=e.slice(1);if(0<=d.indexOf("28147"))b={name:"GOST 28147",version:1989,mode:(a.mode||
("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||64};else if(0<=d.indexOf("3412"))b={name:"GOST R 34.12",version:2015,mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),length:a.length||64};else if(0<=d.indexOf("3411"))b={name:"GOST R 34.11",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||256};else if(0<=
d.indexOf("3410"))b={name:"GOST R 34.10",version:2012,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"DH":"SIGN")).toUpperCase(),length:a.length||256};else if(0<=d.indexOf("SHA"))b={name:"SHA",version:160===(a.length||160)?1:2,mode:(a.mode||("deriveKey"===c||"deriveBits"===c?"KDF":"sign"===c||"verify"===c?"HMAC":"HASH")).toUpperCase(),length:a.length||160};else if(0<=d.indexOf("RC2"))b={name:"RC2",version:1,mode:(a.mode||("sign"===c||"verify"===c?"MAC":"wrapKey"===c||"unwrapKey"===c?"KW":"ES")).toUpperCase(),
length:a.length||32};else if(0<=d.indexOf("PBKDF2"))b=g(a.hash,"digest"),b.mode="PBKDF2";else if(0<=d.indexOf("PFXKDF"))b=g(a.hash,"digest"),b.mode="PFXKDF";else if(0<=d.indexOf("CPKDF"))b=g(a.hash,"digest"),b.mode="CPKDF";else if(0<=d.indexOf("HMAC"))b=g(a.hash,"digest"),b.mode="HMAC";else throw new s("Algorithm not supported");e.forEach(function(a){a=a.toUpperCase();if(/^[0-9]+$/.test(a))if(0<=["8","16","32"].indexOf(a)||"128"===b.length&&"64"===a)if("ES"===b.mode)b.shiftBits=parseInt(a);else if("MAC"===
b.mode)b.macLength=parseInt(a);else throw new s("Algorithm "+b.name+" mode "+a+" not supported");else 0<="89 94 01 12 15 1989 1994 2001 2012 2015".split(" ").indexOf(a)?(a=parseInt(a),b.version=1900>a?80>a?2E3+a:1900+a:a):0<=["1"].indexOf(a)&&"SHA"===b.name?(b.version=1,b.length=160):0<=["256","384","512"].indexOf(a)&&"SHA"===b.name?(b.version=2,b.length=parseInt(a)):0<=["40","128"].indexOf(a)&&"RC2"===b.name?(b.version=1,b.length=parseInt(a)):0<=["64","128","256","512"].indexOf(a)?b.length=parseInt(a):
0<=["1000","2000"].indexOf(a)&&(b.iterations=parseInt(a));else if(0<="E-TEST E-A E-B E-C E-D E-SC E-Z D-TEST D-A D-SC".split(" ").indexOf(a))b.sBox=a;else if(0<="S-TEST S-A S-B S-C S-D X-A X-B X-C".split(" ").indexOf(a))b.namedParam=a;else if(0<="S-256-TEST S-256-A S-256-B S-256-C P-256 T-512-TEST T-512-A T-512-B X-256-A X-256-B T-256-TEST T-256-A T-256-B S-256-B T-256-C S-256-C".split(" ").indexOf(a))b.namedCurve=a;else if(0<=["SC","CP","VN"].indexOf(a))b.procreator=a;else if("GOST 28147"===b.name||
"GOST R 34.12"===b.name||"RC2"===b.name)if(0<=["ES","MAC","KW","MASK"].indexOf(a))b.mode=a;else if(0<=["ECB","CFB","OFB","CTR","CBC"].indexOf(a))b.mode="ES",b.block=a;else if(0<=["CPKW","NOKW","SCKW"].indexOf(a))b.mode="KW",b.keyWrapping=a.replace("KW","");else if(0<=["ZEROPADDING","PKCS5PADDING","NOPADDING","RANDOMPADDING","BITPADDING"].indexOf(a))b.padding=a.replace("PADDING","");else if(0<=["NOKM","CPKM"].indexOf(a))b.keyMeshing=a.replace("KM","");else throw new s("Algorithm "+b.name+" mode "+
a+" not supported");else if("GOST R 34.11"===b.name||"SHA"===b.name)if(0<="HASH KDF HMAC PBKDF2 PFXKDF CPKDF".split(" ").indexOf(a))b.mode=a;else throw new s("Algorithm "+b.name+" mode "+a+" not supported");else if("GOST R 34.10"===b.name){var c=a.replace(/[\.\s]/g,"");if(0<=c.indexOf("GOST")&&0<=c.indexOf("3411"))b.hash=a;else if(["SIGN","DH","MASK"].indexOf(a))b.mode=a;else throw new s("Algorithm "+b.name+" mode "+a+" not supported");}});b.procreator=a.procreator||b.procreator||"CP";switch(b.name){case "GOST R 34.10":b.keySize=
b.length/(1994===b.version?4:8);break;case "GOST R 34.11":b.keySize=32;break;case "GOST 28147":case "GOST R 34.12":b.keySize=32;break;case "RC2":b.keySize=Math.ceil(b.length/8);break;case "SHA":b.keySize=b.length/8}if("ES"===b.mode&&(a.block&&(b.block=a.block),b.block&&(b.block=b.block.toUpperCase()),a.padding&&(b.padding=a.padding),b.padding&&(b.padding=b.padding.toUpperCase()),a.shiftBits&&(b.shiftBits=a.shiftBits),a.keyMeshing&&(b.keyMeshing=a.keyMeshing),b.keyMeshing&&(b.keyMeshing=b.keyMeshing.toUpperCase()),
"importKey"!==c&&"generateKey"!==c)){b.block=b.block||"ECB";b.padding=b.padding||("CBC"===b.block||"ECB"===b.block?"ZERO":"NO");if("CFB"===b.block||"OFB"===b.block)b.shiftBits=b.shiftBits||b.length;b.keyMeshing=b.keyMeshing||"NO"}"KW"===b.mode&&(a.keyWrapping&&(b.keyWrapping=a.keyWrapping),b.keyWrapping&&(b.keyWrapping=b.keyWrapping.toUpperCase()),"importKey"!==c&&"generateKey"!==c&&(b.keyWrapping=b.keyWrapping||"NO"));"sBox namedParam namedCurve curve param modulusLength".split(" ").forEach(function(c){a[c]&&
(b[c]=a[c])});"importKey"!==c&&"generateKey"!==c&&("GOST 28147"===b.name?b.sBox=b.sBox||("SC"===b.procreator?"E-SC":"E-A"):"GOST R 34.12"===b.name&&64===b.length?b.sBox="E-Z":"GOST R 34.11"===b.name&&1994===b.version?b.sBox=b.sBox||("SC"===b.procreator?"D-SC":"D-A"):"GOST R 34.10"===b.name&&1994===b.version?b.namedParam=b.namedParam||("DH"===b.mode?"X-A":"S-A"):"GOST R 34.10"===b.name&&2001===b.version?b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"DH"===b.mode?"X-256-A":
"S-256-A":"T-512-A"===b.mode):"GOST R 34.10"===b.name&&2012===b.version&&(b.namedCurve=b.namedCurve||(256===b.length?"SC"===b.procreator?"P-256":"DH"===b.mode?"X-256-A":"S-256-A":"T-512-A"===b.mode)));switch(b.mode){case "DH":a.ukm&&(b.ukm=a.ukm);a["public"]&&(b["public"]=a["public"]);break;case "SIGN":case "KW":a.ukm&&(b.ukm=a.ukm);break;case "ES":case "MAC":a.iv&&(b.iv=a.iv);break;case "KDF":a.label&&(b.label=a.label);a.contex&&(b.context=a.contex);break;case "PBKDF2":a.salt&&(b.salt=a.salt);a.iterations&&
(b.iterations=a.iterations);a.diversifier&&(b.diversifier=a.diversifier);break;case "PFXKDF":a.salt&&(b.salt=a.salt);a.iterations&&(b.iterations=a.iterations);a.diversifier&&(b.diversifier=a.diversifier);break;case "CPKDF":a.salt&&(b.salt=a.salt),a.iterations&&(b.iterations=a.iterations)}if(c&&("ES"!==b.mode&&"SIGN"!==b.mode&&"MAC"!==b.mode&&"HMAC"!==b.mode&&"KW"!==b.mode&&"DH"!==b.mode&&"MASK"!==b.mode&&"generateKey"===c||"ES"!==b.mode&&("encrypt"===c||"decrypt"===c)||"SIGN"!==b.mode&&"MAC"!==b.mode&&
"HMAC"!==b.mode&&("sign"===c||"verify"===c)||"HASH"!==b.mode&&"digest"===c||"KW"!==b.mode&&"MASK"!==b.mode&&("wrapKey"===c||"unwrapKey"===c)||"DH"!==b.mode&&"PBKDF2"!==b.mode&&"PFXKDF"!==b.mode&&"CPKDF"!==b.mode&&"KDF"!==b.mode&&("deriveKey"===c||"deriveBits"===c)))throw new s("Algorithm mode "+b.mode+" not valid for method "+c);a.hash&&(b.hash=a.hash);b.hash&&(("string"===typeof b.hash||b.hash instanceof String)&&b.procreator&&(b.hash=b.hash+"/"+b.procreator),b.hash=g(b.hash,"digest"));a.id&&(b.id=
a.id);return b}function q(a){if(!k||!k.subtle||!a)return!1;var c="string"===typeof a||a instanceof String?c=a:a.name;if(!c)return!1;c=c.toUpperCase();return(0<=c.indexOf("KDF")||0<=c.indexOf("HMAC"))&&a.hash?q(a.hash):-1===c.indexOf("GOST")&&-1===c.indexOf("SHA-1")&&-1===c.indexOf("RC2")&&-1===c.indexOf("?DES")}function F(a,c){if(!a.algorithm)throw new v("Key algorithm not defined");if(!a.algorithm.name)throw new v("Key algorithm name not defined");var d=a.algorithm.name,e="GOST 28147"===d||"GOST R 34.12"===
d||"RC2"===d,b="GOST R 34.11"===d||"SHA"===d,h="GOST R 34.10"===d;if(!e&&!h&&!b)throw new s("Key algorithm "+d+" is unsupproted");if(!a.type)throw new v("Key type not defined");if((e||b)&&"secret"!==a.type||h&&"public"!==a.type&&"private"!==a.type)throw new B("Key type "+a.type+" is not valid for algorithm "+d);if(!a.usages||!a.usages.indexOf)throw new v("Key usages not defined");d=0;for(e=a.usages.length;d<e;d++)if(b=a.usages[d],("encrypt"===b||"decrypt"===b)&&"secret"!==a.type||"sign"===b&&"public"===
a.type||"verify"===b&&"private"===a.type)throw new J("Key type "+a.type+" is not valid for "+b);if(c&&-1===a.usages.indexOf(c))throw new G("Key usages is not contain method "+c);if(!a.buffer)throw new v("Key buffer is not defined");d=8*a.buffer.byteLength;e=8*a.algorithm.keySize;if("secret"===a.type&&d!==(e||256)&&(0<=a.usages.indexOf("encrypt")||0<=a.usages.indexOf("decrypt"))||"private"===a.type&&256!==d&&512!==d||"public"===a.type&&512!==d&&1024!==d)throw new v("Key buffer has wrong size "+d+" bit");
}function n(a,c,d){F(d,a);if(c){var e;switch(c.mode){case "ES":e=["sBox","keyMeshing","padding","block"];break;case "SIGN":e="namedCurve namedParam sBox curve param modulusLength".split(" ");break;case "MAC":e=["sBox"];break;case "KW":e=["keyWrapping","ukm"];break;case "DH":e="namedCurve namedParam sBox ukm curve param modulusLength".split(" ");break;case "KDF":e=["context","label"];break;case "PBKDF2":e=["sBox","iterations","salt"];break;case "PFXKDF":e=["sBox","iterations","salt","diversifier"];
break;case "CPKDF":e=["sBox","salt"]}e&&e.forEach(function(a){d.algorithm[a]&&(c[a]=d.algorithm[a])})}return d.buffer}function A(a,c,d,e,b){a={type:b||("GOST R 34.10"===a.name?"private":"secret"),extractable:c||"false",algorithm:a,usages:d||[],buffer:e};F(a);return a}function K(a,c,d,e,b,h){if(!e||!e.indexOf)throw new v("Key usages not defined");var z=e.filter(function(a){return"sign"!==a});e=e.filter(function(a){return"verify"!==a});return{publicKey:A(a,d,z,b,"public"),privateKey:A(c,d,e,h,"private")}}
function H(a){a instanceof L&&(a=new Uint8Array(a));for(var c=new Uint8Array(a.length),d=0,e=a.length;d<e;d++)c[e-d-1]=a[d];return c.buffer}function I(){for(var a=0,c=arguments.length;a<c;a++){var d=arguments[a].split("."),d=C+d[0]+D+"."+d[1],e=document.querySelector('script[src="'+d+'"]');e||(e=document.createElement("script"),e.setAttribute("src",d),document.head.appendChild(e))}}function m(a,c,d){return new Promise(function(e,b){try{if(x){var h=++M;w.push({id:h,resolve:e,reject:b});x.postMessage({id:h,
algorithm:a,method:c,args:d})}else f.gostEngine?e(f.gostEngine.execute(a,c,d)):b(new E("Module gostEngine not found"))}catch(z){b(z)}})}function t(a){try{a()}catch(c){}}function l(){}var f=this,k=f.crypto||f.msCrypto,v=f.SyntaxError||f.Error,B=f.DataError||f.Error,s=f.NotSupportedError||f.Error,E=f.OperationError||f.Error,J=f.InvalidAccessError||f.Error,G=f.InvalidAccessError||f.Error;f.Promise||(f.Promise=function(){function a(a){return a&&null===a.oncomplete&&null===a.onerror?new c(function(c,b){a.oncomplete=
function(){c(a.result)};a.onerror=function(){b(new E(a.toString()))}}):a}function c(d){function e(a){try{a()}catch(b){}}var b="pending",h,z=[],g=[];try{d(function(a){"pending"===b&&(b="fulfilled",h=a,z.forEach(e))},function(a){"pending"===b&&(b="rejected",h=a,g.forEach(e))})}catch(f){"pending"===b&&(b="rejected",h=f,g.forEach(e))}this.then=function(d,e){return new c(function(c,f){function p(){var b;try{b=d?d(h):h}catch(e){f(e);return}(b=a(b))&&b.then&&b.then.call?b.then(c,f):c(b)}function k(){var b;
try{b=e?e(h):h}catch(d){f(d);return}(b=a(b))&&b.then&&b.then.call?b.then(c,f):f(b)}"fulfilled"===b?p():"rejected"===b?k():(z.push(p),g.push(k))})};this["catch"]=function(a){return this.then(void 0,a)}}c.all=function(a){return new c(function(c,b){function h(a){p++;return function(b){g[a]=b;p--;0===p&&c(g)}}function f(a){0<p&&b(a);p=0}for(var g=[],p=0,k=0,q=a.length;k<q;k++){var m=a[k];m.then&&m.then.call?m.then(h(k),f):g[k]=m}0===p&&c(g)})};return c}());var C="",D="";"undefined"!==typeof document&&
function(){for(var a=/^(.*)gostCrypto(.*)\.js$/i,c=document.querySelectorAll("script"),d=0,e=c.length;d<e;d++){var b=c[d].getAttribute("src");if(b=a.exec(b))C=b[1],D=b[2]}}();var x,w=[],M=0;if(!f.importScripts&&!f.gostEngine)try{x=new Worker(C+"gostEngine"+D+".js"),x.onmessage=function(a){for(var c=a.data.id,d=0,e=w.length;d<e&&w[d].id!==c;d++);d<e&&(c=w[d],w.splice(d,1),a.data.error?c.reject(new E(a.data.error)):c.resolve(a.data.result))},x.onerror=function(a){for(var c=0,d=w.length;c<d;c++)w[c].reject(a.error);
w=[]}}catch(N){x=!1}f.importScripts||(f.importScripts=I);x||f.gostEngine||I("gostEngine.js");var L=f.ArrayBuffer,u={};l.prototype.encrypt=function(a,c,d){return(new Promise(t)).then(function(){if(q(a))return k.subtle.encrypt(a,c,d);a=g(a,"encrypt");return m(a,"encrypt",[n("encrypt",a,c),d])})};l.prototype.decrypt=function(a,c,d){return(new Promise(t)).then(function(){if(q(a))return k.subtle.decrypt(a,c,d);a=g(a,"decrypt");return m(a,"decrypt",[n("decrypt",a,c),d])})};l.prototype.sign=function(a,c,
d){return(new Promise(t)).then(function(){if(q(a))return k.subtle.sign(a,c,d);a=g(a,"sign");return m(a,"sign",[n("sign",a,c),d]).then(function(c){return"SC"===a.procreator&&"SIGN"===a.mode?u.asn1.GostSignature.encode(c):c})})};l.prototype.verify=function(a,c,d,e){return(new Promise(t)).then(function(){if(q(a))return k.subtle.verify(a,c,d,e);a=g(a,"verify");return m(a,"verify",[n("verify",a,c),"SC"===a.procreator&&"SIGN"===a.mode?u.asn1.GostSignature.decode(d):d,e])})};l.prototype.digest=function(a,
c){return(new Promise(t)).then(function(){if(q(a))return k.subtle.digest(a,c);a=g(a,"digest");return m(a,"digest",[c])})};l.prototype.generateKey=function(a,c,d){return(new Promise(t)).then(function(){if(q(a))return k.subtle.generateKey(a,c,d);var e=a.privateKey,b=a.publicKey;a=g(a,"generateKey");e=e?g(e,"generateKey"):a;b=b?g(b,"generateKey"):a;return m(a,"generateKey",[]).then(function(h){return h.publicKey&&h.privateKey?K(b,e,c,d,h.publicKey,h.privateKey):A(a,c,d,h)})})};l.prototype.deriveKey=
function(a,c,d,e,b){return(new Promise(t)).then(function(){if(q(a))return k.subtle.deriveKey(a,c,d,e,b);a=g(a,"deriveKey");d=g(d,"generateKey");a.keySize=d.keySize;a["public"]&&(a["public"].algorithm=g(a["public"].algorithm),a["public"]=n("deriveKey",a,a["public"]));return m(a,"deriveKey",[n("deriveKey",a,c)]).then(function(a){return A(d,e,b,a)})})};l.prototype.deriveBits=function(a,c,d){return(new Promise(t)).then(function(){if(q(a))return k.subtle.deriveBits(a,c,d);a=g(a,"deriveBits");a["public"]&&
(a["public"]=n("deriveBits",a,a["public"]));return m(a,"deriveBits",[n("deriveBits",a,c),d])})};l.prototype.importKey=function(a,c,d,e,b){var h;return(new Promise(t)).then(function(){if(q(d))return k.subtle.importKey(a,c,d,e,b);if("raw"===a){d=g(d,"importKey");if(b&&b.indexOf){var f=d.name.toUpperCase().replace(/[\.\s]/g,"");0<=f.indexOf("3410")&&0<=b.indexOf("sign")?h="private":0<=f.indexOf("3410")&&0<=b.indexOf("verify")&&(h="public")}return c}var r;if("pkcs8"===a)r=u.asn1.GostPrivateKeyInfo.decode(c).object;
else if("spki"===a)r=u.asn1.GostSubjectPublicKeyInfo.decode(c).object;else throw new s("Key format not supported");d=g(r.algorithm,"importKey");h=r.type;!1!==e&&(e=e||r.extractable);if(b)for(f=0;f<b.length;f++){if(0>r.usages.indexOf(b[f]))throw B("Key usage not valid for this key");}else b=r.usages;r=r.buffer;var p=d.keySize,l=r.byteLength;if("public"===h||p===l)return r;if(0<l%p)throw new B("Invalid key size");d.mode="MASK";d.procreator="VN";for(var n=[],f=p;f<l;f+=p)n.push(function(a){return function(b){return m(d,
"unwrapKey",[a,b]).then(function(a){var b=n.pop();if(b)return b(a);delete d.mode;return a})}}(new Uint8Array(r,f,p)));return n.pop()(new Uint8Array(r,0,p))}).then(function(a){return A(d,e,b,a,h)})};l.prototype.exportKey=function(a,c){return(new Promise(t)).then(function(){if(c&&q(c.algorithm))return k.subtle.exportKey(a,c);if(!c.extractable)throw new G("Key not extractable");var d=n(null,null,c);if("raw"===a)return d;if("pkcs8"===a&&c.algorithm&&c.algorithm.id){if("VN"===c.algorithm.procreator){var e=
c.algorithm,b;e.mode="MASK";return m(e,"generateKey").then(function(a){b=a;return m(e,"wrapKey",[b,c.buffer])}).then(function(a){delete e.mode;var c=new Uint8Array(a.byteLength+b.byteLength);c.set(new Uint8Array(a,0,a.byteLength));c.set(new Uint8Array(b,0,b.byteLength),a.byteLength);a=c.buffer;a.enclosed=!0;return u.asn1.GostPrivateKeyInfo.encode({algorithm:e,buffer:a})})}return u.asn1.GostPrivateKeyInfo.encode(c)}if("spki"===a&&c.algorithm&&c.algorithm.id)return u.asn1.GostSubjectPublicKeyInfo.encode(c);
throw new s("Key format not supported");})};l.prototype.wrapKey=function(a,c,d,e){return(new Promise(t)).then(function(){if(q(e))return k.subtle.wrapKey(a,c,d,e);e=g(e,"wrapKey");var b=n(null,null,c);"SC"===e.procreator&&"private"===c.type&&(b=H(b));return m(e,"wrapKey",[n("wrapKey",e,d),b]).then(function(b){if("raw"===a)return b;throw new s("Key format not supported");})})};l.prototype.unwrapKey=function(a,c,d,e,b,f,l){return(new Promise(t)).then(function(){if(q(e))return k.subtle.unwrapKey(a,c,
d,e,b,f,l);e=g(e,"unwrapKey");b=g(b,"importKey");if("raw"!==a)throw new s("Key format not supported");return m(e,"unwrapKey",[n("unwrapKey",e,d),c]).then(function(a){var c;if(b&&b.name){var d=b.name.toUpperCase().replace(/[\.\s]/g,"");0<=d.indexOf("3410")&&0<=l.indexOf("sign")?c="private":0<=d.indexOf("3410")&&0<=l.indexOf("verify")&&(c="public")}"SC"===e.procreator&&"private"===c&&(a=H(a));return A(b,f,l,a,c)})})};u.subtle=new l;u.getRandomValues=function(a){var c=(y=y||f.GostRandom)?new y:k;if(c.getRandomValues)c.getRandomValues(a);
else throw new s("Random generator not found");};return u});
