/*
 2014-2015, Rudolf Nickolaev. All rights reserved.
*/
(function(p,k){"function"===typeof define&&define.amd?define(["gostCrypto","gostASN1","gostCert"],k):"object"===typeof exports?module.exports=k(require("gostCrypto"),require("gostASN1"),require("gostCert")):p.GostCMS=k(p.gostCrypto,p.GostASN1,p.GostCert)})(this,function(p){function k(){for(var a={},b=0,c=arguments.length;b<c;b++){var d=arguments[b];if("object"===typeof d)for(var e in d)d.hasOwnProperty(e)&&(a[e]=d[e])}return a}function P(a,b,c){for(var d in b){var e=a,f=d,g=b[d];"object"!==typeof g&&
(g={value:g});void 0!==c&&(g.enumerable=c);D.defineProperty(e,f,g)}}function y(a,b,c,d){"function"!==typeof b&&(d=c,c=b,b=function(){a.apply(this,arguments)});b.prototype=D.create(a.prototype,{constructor:{value:b},superclass:{value:a.prototype}});c&&P(b.prototype,c,!0);if(a!==D)for(var e in a)b[e]=a[e];b.super=a;d&&P(b,d,!0);return b}function l(a){try{a()}catch(b){}}function E(a,b){var c=new Uint8Array(a),d=new Uint8Array(b);if(c.length!==d.length)return!1;for(var e=0,f=c.length;e<f;e++)if(c[e]!==
d[e])return!1;return!0}function F(a,b){for(var c in a)if(a[c]!==b[c])return!1;for(c in b)if(a[c]!==b[c])return!1;return!0}function G(a,b,c){for(var d=!1,e=0,f=a.length;e<f;e++)if(c(a[e],b)){d=!0;break}d||a.push(b)}function H(a,b){var c=a.content;switch(a.contentType){case "data":a.content=b.content;break;case "digestedData":case "signedData":case "authData":c.encapContentInfo={eContentType:b.contentType,eContent:b.content};break;case "envelopedData":case "encryptedData":c.encryptedContentInfo={contentType:b.contentType,
encryptedContent:b.content}}}function Q(a){var b=a.content;switch(a.contentType){case "data":return{contentType:a.contentType,content:a.content};case "digestedData":case "signedData":case "authData":return a=b.encapContentInfo,{contentType:a.eContentType,content:a.eContent};case "envelopedData":case "encryptedData":return a=b.encryptedContentInfo,{contentType:a.contentType,content:a.encryptedContent}}}function I(a){var b;if(a){if("string"===typeof a)try{a=A.PEM.decode(a)}catch(c){a=A.Chars.decode(a)}if(a instanceof
w)try{a=t.ContentInfo.decode(a)}catch(d){a={contentType:"data",content:a}}b=a.contentType;if(!b)throw Error("Invalid content object");a=a.content;a instanceof w||(a=a.encode());return{contentType:b,content:a}}return a={contentType:"data"}}function z(a){try{a=new t.ContentInfo(a.content,!0)}catch(b){}switch(a.contentType){case "data":return new q(a);case "digestedData":return new J(a);case "signedData":return new K(a);case "encryptedData":return new L(a);case "envelopedData":return new M(a);default:return new t.ContentInfo(a)}}
function B(a,b){return a instanceof w?b.extensions&&E(a,b.extensions.subjectKeyIdentifier):F(b.issuer,a.issuer)&&N(b.serialNumber,a.serialNumber)}function C(a){a=new Uint8Array(a);p.getRandomValues(a);return a.buffer}function T(a){switch(a.id){case "pbewithSHAAnd40BitRC2-CBC":case "pbeWithSHAAnd128BitRC2-CBC":return 8;case "pbeUnknownGost":return 16;case "sha1":return 20;default:return 32}}function R(a,b){if(!b)return new w(0);if(b instanceof w)return b;if("string"!==typeof b)throw Error("The password must be string or raw data type");
if(0<=a.name.indexOf("CPKDF")){for(var c=[],d=0;d<b.length;d++){var e=b.charCodeAt(d);c.push(e&255);c.push(e>>>8&255);c.push(0);c.push(0)}return(new Uint8Array(c)).buffer}return 0<=a.name.indexOf("PFXKDF")?A.Chars.decode(b+"\x00","unicode"):A.Chars.decode(b,"utf8")}function x(){}function q(a,b){t.ContentInfo.call(this,a||b||{contentType:"data"});if(b&&this.contentType!==(b.contentType||"data"))throw Error("Invalid content type");}function J(a){q.call(this,a,{contentType:"digestedData",version:0,digestAlgorithm:v[r.providerName].digest,
encapContentInfo:{eContentType:"data"},digest:new w(0)})}function K(a){q.call(this,a,{contentType:"signedData",version:1,digestAlgorithms:[],encapContentInfo:{eContentType:"data"},signerInfos:[]})}function L(a){q.call(this,a,{contentType:"encryptedData",version:0,encryptedContentInfo:{contentType:"data",contentEncryptionAlgorithm:v[r.providerName].encryption}})}function M(a){q.call(this,a,{contentType:"envelopedData",version:0,recipientInfos:[],encryptedContentInfo:{contentType:"data",contentEncryptionAlgorithm:v[r.providerName].encryption}})}
var m=this.Promise,D=this.Object,w=this.ArrayBuffer,U=this.Date,h=p.subtle,t=p.asn1,A=p.coding,V=p.cert,v=p.security.providers,N=function(){var a=function(a){var b=typeof a;return"undefined"===b||""===a?"0":"number"===b||a instanceof Number?a.toString(16).toLowerCase():a.replace("0x","").toLowerCase()},b=function(a,b){return(Array(b+1).join("0")+a).slice(-b)};return function(c,d){c=a(c);d=a(d);var e=Math.max(c.length,d.length);return b(c,e)===b(d,e)}}(),r={providerName:"CP-01",autoAddCert:!1,useKeyIdentifier:!1};
x.prototype.options=r;y(t.ContentInfo,q,{isDetached:{value:!1,enumerable:!0,writable:!0},writeDetached:function(a){this.isDetached=a},encode:function(a){if(this.isDetached){var b=Q(this);H(this,{contentType:b.contentType});a=t.ContentInfo.method("encode").call(this,a);H(this,b);return a}return t.ContentInfo.method("encode").call(this,a)},encloseContent:function(a){var b=this;return(new m(l)).then(function(){b.setEnclosed(a);return b})},setEnclosed:function(a){H(this,I(a))},getEnclosed:function(){return z(Q(this))}});
x.prototype.DataContentInfo=q;y(q,J,{encloseContent:function(a,b){var c=this;return(new m(l)).then(function(){c.setEnclosed(a);if(b){var d=v[b];c.digestAlgorithm=d&&d.digest||b}return h.digest(c.digestAlgorithm,c.encapContentInfo.eContent)}).then(function(a){c.digest=a})},verify:function(a){var b=this;return(new m(l)).then(function(){a&&b.setEnclosed(a);if(!b.encapContentInfo||!b.encapContentInfo.eContent)throw Error("Detached content is not found");return h.digest(b.digestAlgorithm,b.encapContentInfo.eContent)}).then(function(a){if(!E(a,
b.digest))throw Error("Message digest is not verified");return z({contentType:b.encapContentInfo.eContentType,content:b.encapContentInfo.eContent})})}});x.prototype.DigestedDataContentInfo=J;y(q,K,{addSignature:function(a,b,c,d){var e=this,f,g,n;return(new m(l)).then(function(){if(!a||!b)throw Error("Signer key or certificate is not defined");b instanceof Array?(n=b,b=n[0]):n=[b];var s=b.getProvider()||v[r.providerName],S=r.useKeyIdentifier&&b.extensions&&b.extensions.subjectKeyIdentifier;g=e.encapContentInfo.eContent;
f={version:S?2:0,sid:S?b.extensions.subjectKeyIdentifier:{issuer:b.issuer,serialNumber:b.serialNumber},digestAlgorithm:s.digest,signatureAlgorithm:b.subjectPublicKeyInfo.algorithm};d&&(f.unsignedAttrs=d);if(c)return"object"!==typeof c&&(c={}),h.digest(f.digestAlgorithm,g)}).then(function(b){b&&(c.contentType=e.encapContentInfo.eContentType,c.messageDigest=b,c.signingTime=new U,f.signedAttrs=c,g=t.SignedAttributes.encode(f.signedAttrs));return h.importKey("pkcs8",t.PrivateKeyInfo.encode(a),a.privateKeyAlgorithm,
!1,["sign"])}).then(function(a){var b=k(f.signatureAlgorithm,{hash:f.digestAlgorithm});return h.sign(b,a,g)}).then(function(a){f.signatureValue=a;G(e.digestAlgorithms,f.digestAlgorithm,function(a,b){return a.id===b.id});if(r.autoAddCert){e.certificates||(e.certificates=[]);a=0;for(var b=n.length;a<b;a++)G(e.certificates,n[a],function(a,b){return F(a.issuer,b.issuer)&&N(a.serialNumber,b.serialNumber)})}e.signerInfos.push(f)})},isDegenerate:{get:function(){return!(this.signerInfos&&0<this.signerInfos.length)}},
verify:function(a,b){var c=this,d;return(new m(l)).then(function(){b&&c.setEnclosed(b);if(!c.signerInfos||0===c.signerInfos.length)throw Error("No signatures found");return m.all(c.signerInfos.map(function(b,d){var g=b.sid,g=g instanceof w?{subjectKeyIdentifier:g}:{issuer:g.issuer,serialNumber:g.serialNumber},h;b.signedAttrs&&b.signedAttrs.signingTime&&(h=b.signedAttrs.signingTime);return a.getValidCertificate(g,c.certificates,c.crls,h).catch(function(){})}))}).then(function(a){var b=[];a.forEach(function(a){a&&
b.push(c.verifySignature(a).then(function(a){d=a},function(){}))});if(0===b.length)throw Error("Valid verification path not found");return m.all(b)}).then(function(){if(!d)throw Error("Verification path found but no valid signature");return d})},verifySignature:function(a,b){var c=this,d,e,f;return(new m(l)).then(function(){b&&c.setEnclosed(b);e=c.encapContentInfo&&c.encapContentInfo.eContent;if(!e)throw Error("Detached content is not found");for(var g=0;g<c.signerInfos.length;g++)if(B(c.signerInfos[g].sid,
a)){d=c.signerInfos[g];break}if(!d)throw Error("Signature not found for the certificate");if(d.signedAttrs){f=d.signedAttrs.messageDigest;if(!f)throw Error("Message digest must present in signed attributes");e=d.signedAttrs.encode()}if(!e)throw Error("Data for verification not found");g=k(d.signatureAlgorithm,{hash:d.digestAlgorithm});return a.verifySignature(e,d.signatureValue,g)}).then(function(a){if(!a)throw Error("Signature not verified");if(d.signedAttrs)return h.digest(d.digestAlgorithm,c.encapContentInfo.eContent)}).then(function(a){if(a&&
!E(a,f))throw Error("Message digest not verified");return z({contentType:c.encapContentInfo.eContentType,content:c.encapContentInfo.eContent})})}});x.prototype.SignedDataContentInfo=K;y(q,L,{encloseContent:function(a,b,c){var d=this,e,f;return(new m(l)).then(function(){a=I(a);if(!a.content)throw Error("Content for encryption must be specified");var d="string"===typeof b?"pbes":"encryption";if(c){var n=v[c];c=n&&n[d]||c}else c=v[r.providerName][d];if(c.derivation){f=k(c.derivation);e=k(c.encryption);
f.salt=C(T(c));var s;return h.importKey("raw",R(f,b),f,!1,["deriveKey","deriveBits"]).then(function(a){s=a;if(0<=f.name.indexOf("PFXKDF"))return f.diversifier=2,h.deriveBits(f,s,64)}).then(function(a){a&&(e.iv=a);f.diversifier=1;return h.deriveKey(f,s,e,!1,["encrypt"])}).then(function(a){return a})}e=k(c);if(b instanceof w)return h.importKey("raw",b,e,!1,["encrypt"]);if("secret"===b.type)return b;throw Error("Content encryption key must be raw data or secret key type");}).then(function(b){e.iv||(e.iv=
C(8));return h.encrypt(e,b,a.content)}).then(function(b){c.derivation?(delete f.diversifier,c=k(c,{derivation:f,encryption:e})):c=e;d.encryptedContentInfo={contentType:a.contentType,contentEncryptionAlgorithm:c,encryptedContent:b};return d})},getEnclosed:function(a,b){var c=this,d,e,f;return(new m(l)).then(function(){b&&c.setEnclosed(b);f=c.encryptedContentInfo.encryptedContent;if(!f)throw Error("Encrypted content must be specified");d=k(c.encryptedContentInfo.contentEncryptionAlgorithm);if(d.derivation){e=
k(d.derivation);d=k(d.encryption);var g;return h.importKey("raw",R(e,a),e,!1,["deriveKey","deriveBits"]).then(function(a){g=a;if(0<=e.name.indexOf("PFXKDF"))return e.diversifier=2,h.deriveBits(e,g,64)}).then(function(a){a&&(d.iv=a);e.diversifier=1;return h.deriveKey(e,g,d,!1,["decrypt"])})}if(a instanceof w)return h.importKey("raw",a,d,!1,["decrypt"]);if("secret"===a.type)return a;throw Error("Decryption key must be raw data or secret key type");}).then(function(a){return h.decrypt(d,a,f)}).then(function(a){return z({contentType:c.encryptedContentInfo.contentType,
content:a})})}});x.prototype.EncryptedDataContentInfo=L;y(q,M,{encloseContent:function(a,b){var c=this;return(new m(l)).then(function(){a=I(a);if(!a.content)throw Error("Content for encryption must be specified");if(b){var c=v[b];b=c&&c.encryption||b}else b=v[r.providerName].encryption;return h.generateKey(b,!0,["encrypt"])}).then(function(d){c.contentEncryptionKey=d;b.iv||(b.iv=C(8));return h.encrypt(b,d,a.content)}).then(function(d){c.encryptedContentInfo={contentType:a.contentType,contentEncryptionAlgorithm:b,
encryptedContent:d};return c})},addRecipient:function(a,b,c,d){var e=this,f,g,n,s;return(new m(l)).then(function(){a=new V.X509(a);b&&"string"!==typeof b&&!b.algorithm&&(d=c,c=b,b=void 0);g=b?v[b]:a.getProvider();if(!e.contentEncryptionKey)throw Error("The content encryption key is not assigned");if(d){var f;d instanceof Array?(f=d,d=f[0]):f=[d];if(r.autoAddCert){e.originatorInfo?e.originatorInfo.certs||(e.originatorInfo.certs=[]):e.originatorInfo={certs:[]};for(var O=0,n=f.length;O<n;O++)G(e.originatorInfo.certs,
f[O],function(a,b){return F(a.issuer,b.issuer)&&N(a.serialNumber,b.serialNumber)})}g?b=k(g.agreement):g=a.getProvider();if(a.subjectPublicKeyInfo.algorithm.namedCurve!==d.subjectPublicKeyInfo.algorithm.namedCurve)throw Error("The sender and the recipient have different public key algorithms");return h.importKey("pkcs8",c.encode(),c.privateKeyAlgorithm,!1,["deriveKey"])}g?b=k(a.subjectPublicKeyInfo.algorithm):g=a.getProvider();return h.generateKey(b,!0,["deriveKey"]).then(function(a){b["public"]=a.publicKey;
return a.privateKey})}).then(function(b){f=b;return h.importKey("spki",a.subjectPublicKeyInfo.encode(),a.subjectPublicKeyInfo.algorithm,!1,["deriveKey","deriveBits"])}).then(function(a){b.ukm=C(8);n=k(g.agreement,{sBox:b.sBox,ukm:b.ukm,"public":a});s=k(b.wrapping||g.wrapping,{ukm:b.ukm});return h.deriveKey(n,f,s,!0,["wrapKey"])}).then(function(a){b.wrapping=s;return h.wrapKey("raw",e.contentEncryptionKey,a,s)}).then(function(c){var f=r.useKeyIdentifier&&a.extensions&&a.extensions.subjectKeyIdentifier?
a.extensions.subjectKeyIdentifier:{issuer:a.issuer,serialNumber:a.serialNumber};if(d){var g=d.subjectPublicKeyInfo;c={version:3,originator:{algorithm:g.algorithm,publicKey:g.subjectPublicKey},ukm:b.ukm,keyEncryptionAlgorithm:b,recipientEncryptedKeys:[{rid:f,encryptedKey:t.GostEncryptedKey(b).encode(c)}]}}else c={version:0,rid:f,keyEncryptionAlgorithm:b,encryptedKey:t.GostEncryptedKey(b).encode({algorithm:b,sessionEncryptedKey:c})};e.recipientInfos.push(c);return e})},getEnclosed:function(a,b,c,d){var e=
this,f,g,n,s,p;return(new m(l)).then(function(){var a=b.getProvider();c&&e.setEnclosed(c);g=e.encryptedContentInfo.encryptedContent;if(!g)throw Error("Encrypted content must be specified");p=e.encryptedContentInfo.contentEncryptionAlgorithm;for(var m=0;m<e.recipientInfos.length;m++){var l=e.recipientInfos[m],u=k(l.keyEncryptionAlgorithm);if(l.rid){if(B(l.rid,b))return m=t.GostEncryptedKey(u).decode(l.encryptedKey).object,f=m.sessionEncryptedKey,u=k(u,m.algorithm),n=k(a.agreement,{ukm:u.ukm,sBox:u.sBox}),
s=k(a.wrapping,u.wrapping,{ukm:u.ukm}),u["public"]}else{var q=l.recipientEncryptedKeys;if(q)for(var r=0;r<q.length;r++)if(B(q[r].rid,b)){u=k(a.agreement,u,{ukm:l.ukm});f=t.GostEncryptedKey(u).decode(q[r].encryptedKey).object;n=u;s=k(u.wrapping||a.wrapping,{ukm:l.ukm});a=l.originator;if(a.algorithm)return a=new t.SubjectPublicKeyInfo({algorithm:a.algorithm,subjectPublicKey:a.publicKey}),h.importKey("spki",a.encode(),a.algorithm,!1,["deriveKey","deriveBits"]);if(d&&B(a,d))return importKey("pkcs",d.subjectPublicKeyInfo.encode(),
d.subjectPublicKeyInfo.algorithm,!1,["deriveKey","deriveBits"]);throw Error("Originator certificate not specified or not valid");}}}throw Error("Recipient not found or format not supported");}).then(function(b){n["public"]=b;return h.importKey("pkcs8",a.encode(),a.privateKeyAlgorithm,!1,["deriveKey","deriveBits"])}).then(function(a){return h.deriveKey(n,a,s,!0,["unwrapKey"])}).then(function(a){return h.unwrapKey("raw",f,a,s,p,!1,["decrypt"])}).then(function(a){return h.decrypt(p,a,g)}).then(function(a){return z({contentType:e.encryptedContentInfo.contentType,
content:a})})}});x.prototype.EnvelopedDataContentInfo=M;p.cms=new x;return x});
